<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Police Verifier - Tourist ID Check</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 28px auto; padding: 12px; }
    input, button { padding: 8px; margin: 6px; }
    pre { background:#f6f7fb; padding:12px; border-radius:6px; overflow:auto; white-space: pre-wrap; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Police Check-post ‚Äî Tourist Verifier</h1>

  <p>
    Steps:
    <ol>
      <li>Connect MetaMask (Polygon Amoy)</li>
      <li>Enter <b>User ID</b> of tourist</li>
      <li>Check details from blockchain</li>
    </ol>
  </p>

  <div>
    <button id="connect">Connect MetaMask</button>
    <br><br>
    <label>User ID:</label>
    <input id="userId" type="text" placeholder="Enter User ID (e.g., 1, 2, ...)" />
    <button id="verify">Verify Tourist</button>
  </div>

  <div id="status"></div>

  <h3>Verification Output</h3>
  <pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const OUT = document.getElementById('out');
const STATUS = document.getElementById('status');
const connectBtn = document.getElementById('connect');
const verifyBtn = document.getElementById('verify');
let provider;

// CORRECTED ABI for getUserById
const REGISTRY_ABI = [
  {
    "inputs": [
      // Changed from uint256 to string to match the contract
      { "internalType": "string", "name": "userId", "type": "string" }
    ],
    "name": "getUserById",
    "outputs": [
      // Added the userId as the first output to match the contract
      { "internalType": "string", "name": "userId", "type": "string" },
      { "internalType": "string", "name": "passport", "type": "string" },
      { "internalType": "string", "name": "name", "type": "string" },
      { "internalType": "string", "name": "gender", "type": "string" },
      { "internalType": "uint8", "name": "age", "type": "uint8" },
      { "internalType": "string", "name": "nationality", "type": "string" },
      { "internalType": "string", "name": "destination", "type": "string" },
      { "internalType": "address", "name": "issuer", "type": "address" }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const REGISTRY_ADDRESS = "0xd1A614B3A7290816B8d3150A38b8CF76DA524fa7"; // Replace with your deployed address

function log(v) { 
    OUT.textContent = ""; // Clear previous output
    OUT.textContent += JSON.stringify(v, (key, value) =>
        typeof value === 'bigint' ? value.toString() : value, 2
    ) + "\n"; 
}

connectBtn.onclick = async () => {
  if (!window.ethereum) return alert("Please install MetaMask to use this application.");
  
  try {
    STATUS.innerText = "Connecting...";
    provider = new ethers.providers.Web3Provider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    STATUS.innerText = "‚úÖ Connected: " + accounts[0];
  } catch (err) {
    STATUS.innerText = "üî¥ Connection failed.";
    console.error(err);
  }
};

verifyBtn.onclick = async () => {
  OUT.textContent = "";
  const userId = document.getElementById('userId').value.trim();
  if (!userId) return alert("Please enter a User ID");

  if (!provider) {
    STATUS.innerText = "üî¥ Please connect MetaMask first.";
    return;
  }

  try {
    STATUS.innerText = "üîç Verifying...";
    // We only need the provider for read-only calls, not the signer.
    const registry = new ethers.Contract(REGISTRY_ADDRESS, REGISTRY_ABI, provider);
    
    log({ action: "Fetching details for User ID:", userId });

    // CORRECTED: The returned data now matches the updated ABI
    const details = await registry.getUserById(userId);

    const [
        userIdResult,
        passport,
        name,
        gender,
        age,
        nationality,
        destination,
        issuer
    ] = details;


    if (!userIdResult || issuer === ethers.constants.AddressZero) {
      log({ result: "‚ùå User not found on blockchain" });
      STATUS.innerText = "Verification complete: User not found.";
    } else {
      log({ 
        "‚úÖ User Verified": {
            UserID: userIdResult,
            Passport: passport,
            Name: name,
            Gender: gender,
            Age: age,
            Nationality: nationality,
            Destination: destination,
            RegisteredBy: issuer
        }
      });
      STATUS.innerText = "‚úÖ Verification complete.";
    }
  } catch (err) {
    let errorMessage = err.message;
    if (err.reason) {
        errorMessage = err.reason;
    }
    log({ error: "An error occurred", message: errorMessage });
    STATUS.innerText = "üî¥ Verification failed.";
    console.error(err);
  }
};
</script>
</body>
</html>